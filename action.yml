name: "gmod-upload"
description: "Packs a Garry's Mod addon to a .gma file and uploads to the Steam workshop"

branding:
  icon: box
  color: gray-dark

inputs:
  changelog:
    description: "Changelog"
    required: false
    default: ""
  id:
    description: "Workshop item id"
    required: true
  config:
    description: "Path of addon.json, or json file to treat as such."
    required: false
    default: ""
  title:
    description: "The name of the Workshop item"
    required: false
    default: ""
  type:
    # One of: ServerContent, Gamemode, Map, Weapon, Vehicle, NPC, Tool, Effects, Model, Entity
    description: "The type of addon"
    required: false
    default: "ServerContent"
  tag1:
    # One of: fun, roleplay, scenic, movie, realism, cartoon, water, comic, build
    description: "First addon tag"
    required: false
    default: "build"
  tag2:
    # One of: fun, roleplay, scenic, movie, realism, cartoon, water, comic, build
    description: "Second addon tag"
    required: false
    default: ""
  tag3:
    # One of: fun, roleplay, scenic, movie, realism, cartoon, water, comic, build
    description: "Third addon tag"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@master

    - name: Download SteamCMD
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install lib32gcc-s1
        mkdir ~/Steam
        curl -sqL "https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz" | tar zxvf - -C ~/Steam

    - name: Download Lua 5.3
      shell: bash
      run: |
        sudo apt-get install lua5.3

    - name: Run config builder
      shell: bash
      run: |
        cd ${{ github.action_path }}

        # Use a subshell to capture both output and exit status
        CONFIG_OUTPUT=$(lua5.3 ${{ github.action_path }}/config.lua \
            "${{ inputs.config }}" \
            '${{ inputs.title }}' \
            '${{ inputs.type }}' \
            '${{ inputs.tag1 }}' \
            '${{ inputs.tag2 }}' \
            '${{ inputs.tag3 }}' 2>&1; echo $?)

        # Extract exit status
        CONFIG_EXIT_STATUS=${CONFIG_OUTPUT##*$'\n'}

        # Handle a nonzero exit code as a lua error
        if [ "$CONFIG_EXIT_STATUS" -ne 0 ]; then
            FIRST_LINE=`echo "${CONFIG_OUTPUT}" | head -1`

            if [[ $FIRST_LINE =~ .*(.*\.lua):([0-9]+):(.*) ]]; then
                FILE_NAME="${BASH_REMATCH[1]}"
                LINE_NUMBER="${BASH_REMATCH[2]}"
                ERROR_MESSAGE="${BASH_REMATCH[3]}"

                # Format the error message for GitHub Actions
                echo "::error file=${FILE_NAME},line=${LINE_NUMBER}::${ERROR_MESSAGE}"
            fi

            echo "## :x: Failed to generate an addon.json!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Error" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
            echo "$CONFIG_OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo "```" >> GITHUB_STEP_SUMMARY

            exit 1
        fi

        # Remove the exit status from the output
        CONFIG=$(echo "$CONFIG_OUTPUT" | head -n -1)

        # Set the path of the addon json in the local environment
        echo "config_file=$CONFIG" >> "$GITHUB_ENV"

    - name: Run gma packer
      shell: bash
      run: |
        lua5.3 ${{ github.action_path }}/gma.lua ${{ inputs.id }}.gma "$config_file"

    - name: Create .vdf file
      shell: bash
      run: |
        cat > workshop.vdf << EOF
          "workshopitem" {
            "appid" "4000"
            "publishedfileid" "${{ inputs.id }}"
            "contentfolder" "`pwd`/${{ inputs.id }}.gma"
            "changenote" "${{ inputs.changelog }}"
          }
        EOF

    - name: Run SteamCMD
      shell: bash
      run: |
        ~/Steam/steamcmd.sh +login $STEAM_USERNAME $STEAM_PASSWORD +workshop_build_item `pwd -P`/workshop.vdf +quit

    - name: Print Errors
      if: failure()
      shell: bash
      run: |
        echo ~/Steam/logs/stderr.txt
        echo "$(cat ~/Steam/logs/stderr.txt)"
        echo
        echo ~/Steam/logs/workshop_log.txt
        echo "$(cat ~/Steam/logs/workshop_log.txt)"
        echo
        echo ~/Steam/workshopbuilds/depot_build_4000.log
        echo "$(cat ~/Steam/workshopbuilds/depot_build_4000.log)"

        exit 1
